!function(e){"object"==typeof exports&&"object"==typeof module?e(require("../lib/codemirror"),require("../addon/search/searchcursor"),require("../addon/edit/matchbrackets")):"function"==typeof define&&define.amd?define(["../lib/codemirror","../addon/search/searchcursor","../addon/edit/matchbrackets"],e):e(CodeMirror)}(function(e){"use strict";function t(t,n,o){if(0>o&&0==n.ch)return t.clipPos(u(n.line-1));var r=t.getLine(n.line);if(o>0&&n.ch>=r.length)return t.clipPos(u(n.line+1,0));for(var i,l="start",a=n.ch,s=0>o?0:r.length,c=0;a!=s;a+=o,c++){var f=r.charAt(0>o?a-1:a),h="_"!=f&&e.isWordChar(f)?"w":"o";if("w"==h&&f.toUpperCase()==f&&(h="W"),"start"==l)"o"!=h&&(l="in",i=h);else if("in"==l&&i!=h){if("w"==i&&"W"==h&&0>o&&a--,"W"==i&&"w"==h&&o>0){i="w";continue}break}}return u(n.line,a)}function n(e,n){e.extendSelectionsBy(function(o){return e.display.shift||e.doc.extend||o.empty()?t(e.doc,o.head,n):0>n?o.from():o.to()})}function o(e,t){e.operation(function(){for(var n=e.listSelections().length,o=[],r=-1,i=0;n>i;i++){var l=e.listSelections()[i].head;if(!(l.line<=r)){var a=u(l.line+(t?0:1),0);e.replaceRange("\n",a,null,"+insertLine"),e.indentLine(a.line,null,!0),o.push({head:a,anchor:a}),r=l.line+1}}e.setSelections(o)})}function r(t,n){for(var o=n.ch,r=o,i=t.getLine(n.line);o&&e.isWordChar(i.charAt(o-1));)--o;for(;r<i.length&&e.isWordChar(i.charAt(r));)++r;return{from:u(n.line,o),to:u(n.line,r),word:i.slice(o,r)}}function i(e){var t=e.getCursor(),n=e.scanForBracket(t,-1);if(n)for(;;){var o=e.scanForBracket(t,1);if(!o)return;if(o.ch==d.charAt(d.indexOf(n.ch)+1))return e.setSelection(u(n.pos.line,n.pos.ch+1),o.pos,!1),!0;t=u(o.pos.line,o.pos.ch+1)}}function l(e,t){for(var n,o=e.listSelections(),r=[],i=0;i<o.length;i++){var l=o[i];if(!l.empty()){for(var a=l.from().line,s=l.to().line;i<o.length-1&&o[i+1].from().line==s;)s=l[++i].to().line;r.push(a,s)}}r.length?n=!0:r.push(e.firstLine(),e.lastLine()),e.operation(function(){for(var o=[],i=0;i<r.length;i+=2){var l=r[i],a=r[i+1],s=u(l,0),c=u(a),f=e.getRange(s,c,!1);t?f.sort():f.sort(function(e,t){var n=e.toUpperCase(),o=t.toUpperCase();return n!=o&&(e=n,t=o),t>e?-1:e==t?0:1}),e.replaceRange(f,s,c),n&&o.push({anchor:s,head:c})}n&&e.setSelections(o,0)})}function a(t,n){t.operation(function(){for(var o=t.listSelections(),i=[],l=[],a=0;a<o.length;a++){var s=o[a];s.empty()?(i.push(a),l.push("")):l.push(n(t.getRange(s.from(),s.to())))}t.replaceSelections(l,"around","case");for(var c,a=i.length-1;a>=0;a--){var s=o[i[a]];if(!(c&&e.cmpPos(s.head,c)>0)){var f=r(t,s.head);c=f.from,t.replaceRange(n(f.word),f.from,f.to)}}})}function s(t,n){var o=t.getCursor("from"),i=t.getCursor("to");if(0==e.cmpPos(o,i)){var l=r(t,o);if(!l.word)return;o=l.from,i=l.to}var a=t.getRange(o,i),s=t.getSearchCursor(a,n?i:o);(n?s.findNext():s.findPrevious())?t.setSelection(s.from(),s.to()):(s=t.getSearchCursor(a,n?u(t.firstLine(),0):t.clipPos(u(t.lastLine()))),(n?s.findNext():s.findPrevious())?t.setSelection(s.from(),s.to()):l&&t.setSelection(o,i))}var c=e.keyMap.sublime={fallthrough:"default"},f=e.commands,u=e.Pos,h=e.keyMap["default"]==e.keyMap.pcDefault?"Ctrl-":"Cmd-";f[c["Alt-Left"]="goSubwordLeft"]=function(e){n(e,-1)},f[c["Alt-Right"]="goSubwordRight"]=function(e){n(e,1)},f[c[h+"Up"]="scrollLineUp"]=function(e){var t=e.getScrollInfo();if(!e.somethingSelected()){var n=e.lineAtHeight(t.top+t.clientHeight,"local");e.getCursor().line>=n&&e.execCommand("goLineUp")}e.scrollTo(null,t.top-e.defaultTextHeight())},f[c[h+"Down"]="scrollLineDown"]=function(e){var t=e.getScrollInfo();if(!e.somethingSelected()){var n=e.lineAtHeight(t.top,"local")+1;e.getCursor().line<=n&&e.execCommand("goLineDown")}e.scrollTo(null,t.top+e.defaultTextHeight())},f[c["Shift-"+h+"L"]="splitSelectionByLine"]=function(e){for(var t=e.listSelections(),n=[],o=0;o<t.length;o++)for(var r=t[o].from(),i=t[o].to(),l=r.line;l<=i.line;++l)i.line>r.line&&l==i.line&&0==i.ch||n.push({anchor:l==r.line?r:u(l,0),head:l==i.line?i:u(l)});e.setSelections(n,0)},c["Shift-Tab"]="indentLess",f[c.Esc="singleSelectionTop"]=function(e){var t=e.listSelections()[0];e.setSelection(t.anchor,t.head,{scroll:!1})},f[c[h+"L"]="selectLine"]=function(e){for(var t=e.listSelections(),n=[],o=0;o<t.length;o++){var r=t[o];n.push({anchor:u(r.from().line,0),head:u(r.to().line+1,0)})}e.setSelections(n)},c["Shift-"+h+"K"]="deleteLine",f[c[h+"Enter"]="insertLineAfter"]=function(e){o(e,!1)},f[c["Shift-"+h+"Enter"]="insertLineBefore"]=function(e){o(e,!0)},f[c[h+"D"]="selectNextOccurrence"]=function(t){var n=t.getCursor("from"),o=t.getCursor("to"),i=t.state.sublimeFindFullWord==t.doc.sel;if(0==e.cmpPos(n,o)){var l=r(t,n);if(!l.word)return;t.setSelection(l.from,l.to),i=!0}else{var a=t.getRange(n,o),s=i?new RegExp("\\b"+a+"\\b"):a,c=t.getSearchCursor(s,o);c.findNext()?t.addSelection(c.from(),c.to()):(c=t.getSearchCursor(s,u(t.firstLine(),0)),c.findNext()&&t.addSelection(c.from(),c.to()))}i&&(t.state.sublimeFindFullWord=t.doc.sel)};var d="(){}[]";f[c["Shift-"+h+"Space"]="selectScope"]=function(e){i(e)||e.execCommand("selectAll")},f[c["Shift-"+h+"M"]="selectBetweenBrackets"]=function(t){return i(t)?void 0:e.Pass},f[c[h+"M"]="goToBracket"]=function(t){t.extendSelectionsBy(function(n){var o=t.scanForBracket(n.head,1);if(o&&0!=e.cmpPos(o.pos,n.head))return o.pos;var r=t.scanForBracket(n.head,-1);return r&&u(r.pos.line,r.pos.ch+1)||n.head})},f[c["Shift-"+h+"Up"]="swapLineUp"]=function(e){for(var t=e.listSelections(),n=[],o=e.firstLine()-1,r=[],i=0;i<t.length;i++){var l=t[i],a=l.from().line-1,s=l.to().line;r.push({anchor:u(l.anchor.line-1,l.anchor.ch),head:u(l.head.line-1,l.head.ch)}),0!=l.to().ch||l.empty()||--s,a>o?n.push(a,s):n.length&&(n[n.length-1]=s),o=s}e.operation(function(){for(var t=0;t<n.length;t+=2){var o=n[t],i=n[t+1],l=e.getLine(o);e.replaceRange("",u(o,0),u(o+1,0),"+swapLine"),i>e.lastLine()?e.replaceRange("\n"+l,u(e.lastLine()),null,"+swapLine"):e.replaceRange(l+"\n",u(i,0),null,"+swapLine")}e.setSelections(r),e.scrollIntoView()})},f[c["Shift-"+h+"Down"]="swapLineDown"]=function(e){for(var t=e.listSelections(),n=[],o=e.lastLine()+1,r=t.length-1;r>=0;r--){var i=t[r],l=i.to().line+1,a=i.from().line;0!=i.to().ch||i.empty()||l--,o>l?n.push(l,a):n.length&&(n[n.length-1]=a),o=a}e.operation(function(){for(var t=n.length-2;t>=0;t-=2){var o=n[t],r=n[t+1],i=e.getLine(o);o==e.lastLine()?e.replaceRange("",u(o-1),u(o),"+swapLine"):e.replaceRange("",u(o,0),u(o+1,0),"+swapLine"),e.replaceRange(i+"\n",u(r,0),null,"+swapLine")}e.scrollIntoView()})},c[h+"/"]="toggleComment",f[c[h+"J"]="joinLines"]=function(e){for(var t=e.listSelections(),n=[],o=0;o<t.length;o++){for(var r=t[o],i=r.from(),l=i.line,a=r.to().line;o<t.length-1&&t[o+1].from().line==a;)a=t[++o].to().line;n.push({start:l,end:a,anchor:!r.empty()&&i})}e.operation(function(){for(var t=0,o=[],r=0;r<n.length;r++){for(var i,l=n[r],a=l.anchor&&u(l.anchor.line-t,l.anchor.ch),s=l.start;s<=l.end;s++){var c=s-t;s==l.end&&(i=u(c,e.getLine(c).length+1)),c<e.lastLine()&&(e.replaceRange(" ",u(c),u(c+1,/^\s*/.exec(e.getLine(c+1))[0].length)),++t)}o.push({anchor:a||i,head:i})}e.setSelections(o,0)})},f[c["Shift-"+h+"D"]="duplicateLine"]=function(e){e.operation(function(){for(var t=e.listSelections().length,n=0;t>n;n++){var o=e.listSelections()[n];o.empty()?e.replaceRange(e.getLine(o.head.line)+"\n",u(o.head.line,0)):e.replaceRange(e.getRange(o.from(),o.to()),o.from())}e.scrollIntoView()})},c[h+"T"]="transposeChars",f[c.F9="sortLines"]=function(e){l(e,!0)},f[c[h+"F9"]="sortLinesInsensitive"]=function(e){l(e,!1)},f[c.F2="nextBookmark"]=function(e){var t=e.state.sublimeBookmarks;if(t)for(;t.length;){var n=t.shift(),o=n.find();if(o)return t.push(n),e.setSelection(o.from,o.to)}},f[c["Shift-F2"]="prevBookmark"]=function(e){var t=e.state.sublimeBookmarks;if(t)for(;t.length;){t.unshift(t.pop());var n=t[t.length-1].find();if(n)return e.setSelection(n.from,n.to);t.pop()}},f[c[h+"F2"]="toggleBookmark"]=function(e){for(var t=e.listSelections(),n=e.state.sublimeBookmarks||(e.state.sublimeBookmarks=[]),o=0;o<t.length;o++){for(var r=t[o].from(),i=t[o].to(),l=e.findMarks(r,i),a=0;a<l.length;a++)if(l[a].sublimeBookmark){l[a].clear();for(var s=0;s<n.length;s++)n[s]==l[a]&&n.splice(s--,1);break}a==l.length&&n.push(e.markText(r,i,{sublimeBookmark:!0,clearWhenEmpty:!1}))}},f[c["Shift-"+h+"F2"]="clearBookmarks"]=function(e){var t=e.state.sublimeBookmarks;if(t)for(var n=0;n<t.length;n++)t[n].clear();t.length=0},f[c["Alt-F2"]="selectBookmarks"]=function(e){var t=e.state.sublimeBookmarks,n=[];if(t)for(var o=0;o<t.length;o++){var r=t[o].find();r?n.push({anchor:r.from,head:r.to}):t.splice(o--,0)}n.length&&e.setSelections(n,0)},c["Alt-Q"]="wrapLines";var p=e.keyMap["sublime-Ctrl-K"]={auto:"sublime",nofallthrough:!0};c[h+"K"]=function(e){e.setOption("keyMap","sublime-Ctrl-K")},p[h+"Backspace"]="delLineLeft",f[p[h+"K"]="delLineRight"]=function(e){e.operation(function(){for(var t=e.listSelections(),n=t.length-1;n>=0;n--)e.replaceRange("",t[n].anchor,u(t[n].to().line),"+delete");e.scrollIntoView()})},f[p[h+"U"]="upcaseAtCursor"]=function(e){a(e,function(e){return e.toUpperCase()})},f[p[h+"L"]="downcaseAtCursor"]=function(e){a(e,function(e){return e.toLowerCase()})},f[p[h+"Space"]="setSublimeMark"]=function(e){e.state.sublimeMark&&e.state.sublimeMark.clear(),e.state.sublimeMark=e.setBookmark(e.getCursor())},f[p[h+"A"]="selectToSublimeMark"]=function(e){var t=e.state.sublimeMark&&e.state.sublimeMark.find();t&&e.setSelection(e.getCursor(),t)},f[p[h+"W"]="deleteToSublimeMark"]=function(t){var n=t.state.sublimeMark&&t.state.sublimeMark.find();if(n){var o=t.getCursor(),r=n;if(e.cmpPos(o,r)>0){var i=r;r=o,o=i}t.state.sublimeKilled=t.getRange(o,r),t.replaceRange("",o,r)}},f[p[h+"X"]="swapWithSublimeMark"]=function(e){var t=e.state.sublimeMark&&e.state.sublimeMark.find();t&&(e.state.sublimeMark.clear(),e.state.sublimeMark=e.setBookmark(e.getCursor()),e.setCursor(t))},f[p[h+"Y"]="sublimeYank"]=function(e){null!=e.state.sublimeKilled&&e.replaceSelection(e.state.sublimeKilled,null,"paste")},p[h+"G"]="clearBookmarks",f[p[h+"C"]="showInCenter"]=function(e){var t=e.cursorCoords(null,"local");e.scrollTo(null,(t.top+t.bottom)/2-e.getScrollInfo().clientHeight/2)},f[c["Shift-Alt-Up"]="selectLinesUpward"]=function(e){e.operation(function(){for(var t=e.listSelections(),n=0;n<t.length;n++){var o=t[n];o.head.line>e.firstLine()&&e.addSelection(u(o.head.line-1,o.head.ch))}})},f[c["Shift-Alt-Down"]="selectLinesDownward"]=function(e){e.operation(function(){for(var t=e.listSelections(),n=0;n<t.length;n++){var o=t[n];o.head.line<e.lastLine()&&e.addSelection(u(o.head.line+1,o.head.ch))}})},f[c[h+"F3"]="findUnder"]=function(e){s(e,!0)},f[c["Shift-"+h+"F3"]="findUnderPrevious"]=function(e){s(e,!1)},c["Shift-"+h+"["]="fold",c["Shift-"+h+"]"]="unfold",p[h+"0"]=p[h+"j"]="unfoldAll",c[h+"I"]="findIncremental",c["Shift-"+h+"I"]="findIncrementalReverse",c[h+"H"]="replace",c.F3="findNext",c["Shift-F3"]="findPrev"});