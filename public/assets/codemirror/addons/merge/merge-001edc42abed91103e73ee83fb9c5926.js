!function(e){"object"==typeof exports&&"object"==typeof module?e(require("../../lib/codemirror")):"function"==typeof define&&define.amd?define(["../../lib/codemirror"],e):e(CodeMirror)}(function(e){"use strict";function t(e,t){this.mv=e,this.type=t,this.classes="left"==t?{chunk:"CodeMirror-merge-l-chunk",start:"CodeMirror-merge-l-chunk-start",end:"CodeMirror-merge-l-chunk-end",insert:"CodeMirror-merge-l-inserted",del:"CodeMirror-merge-l-deleted",connect:"CodeMirror-merge-l-connect"}:{chunk:"CodeMirror-merge-r-chunk",start:"CodeMirror-merge-r-chunk-start",end:"CodeMirror-merge-r-chunk-end",insert:"CodeMirror-merge-r-inserted",del:"CodeMirror-merge-r-deleted",connect:"CodeMirror-merge-r-connect"}}function r(t){t.diffOutOfDate&&(t.diff=p(t.orig.getValue(),t.edit.getValue()),t.diffOutOfDate=!1,e.signal(t.edit,"updateDiff",t.diff))}function i(e){function t(t){"full"==t&&(e.svg&&M(e.svg),M(e.copyButtons),c(e.edit,l.marked,e.classes),c(e.orig,f.marked,e.classes),l.from=l.to=f.from=f.to=0),r(e),e.showDifferences&&(a(e.edit,e.diff,l,DIFF_INSERT,e.classes),a(e.orig,e.diff,f,DIFF_DELETE,e.classes)),d(e)}function i(e){clearTimeout(n),n=setTimeout(t,1==e?250:100)}function o(){e.diffOutOfDate||(e.diffOutOfDate=!0,l.from=l.to=f.from=f.to=0),i(!0)}var n,l={from:0,to:0,marked:[]},f={from:0,to:0,marked:[]};return e.edit.on("change",o),e.orig.on("change",o),e.edit.on("markerAdded",i),e.edit.on("markerCleared",i),e.orig.on("markerAdded",i),e.orig.on("markerCleared",i),e.edit.on("viewportChange",i),e.orig.on("viewportChange",i),t(),t}function o(e){e.edit.on("scroll",function(){n(e,DIFF_INSERT)&&d(e)}),e.orig.on("scroll",function(){n(e,DIFF_DELETE)&&d(e)})}function n(e,t){if(e.diffOutOfDate)return!1;if(!e.lockScroll)return!0;var r,i,o=+new Date;if(t==DIFF_INSERT?(r=e.edit,i=e.orig):(r=e.orig,i=e.edit),r.state.scrollSetBy==e&&(r.state.scrollSetAt||0)+50>o)return!1;var n,f,c=r.getScrollInfo(),a=.5*c.clientHeight,s=c.top+a,d=r.lineAtHeight(s,"local"),u=D(e.diff,d,t==DIFF_INSERT),h=l(r,t==DIFF_INSERT?u.edit:u.orig),g=l(i,t==DIFF_INSERT?u.orig:u.edit),p=(s-h.top)/(h.bot-h.top),m=g.top-a+p*(g.bot-g.top);if(m>c.top&&(f=c.top/a)<1)m=m*f+c.top*(1-f);else if((n=c.height-c.clientHeight-c.top)<a){var v=i.getScrollInfo(),C=v.height-v.clientHeight-m;C>n&&(f=n/a)<1&&(m=m*f+(v.height-v.clientHeight-n)*(1-f))}return i.scrollTo(c.left,m),i.state.scrollSetAt=o,i.state.scrollSetBy=e,!0}function l(e,t){var r=t.after;return null==r&&(r=e.lastLine()+1),{top:e.heightAtLine(t.before||0,"local"),bot:e.heightAtLine(r,"local")}}function f(e,t,r){e.lockScroll=t,t&&0!=r&&n(e,DIFF_INSERT)&&d(e),e.lockButton.innerHTML=t?"\u21db\u21da":"\u21db&nbsp;&nbsp;\u21da"}function c(t,r,i){for(var o=0;o<r.length;++o){var n=r[o];n instanceof e.TextMarker?n.clear():n.parent&&(t.removeLineClass(n,"background",i.chunk),t.removeLineClass(n,"background",i.start),t.removeLineClass(n,"background",i.end))}r.length=0}function a(e,t,r,i,o){var n=e.getViewport();e.operation(function(){r.from==r.to||n.from-r.to>20||r.from-n.to>20?(c(e,r.marked,o),s(e,t,i,r.marked,n.from,n.to,o),r.from=n.from,r.to=n.to):(n.from<r.from&&(s(e,t,i,r.marked,n.from,r.from,o),r.from=n.from),n.to>r.to&&(s(e,t,i,r.marked,r.to,n.to,o),r.to=n.to))})}function s(e,t,r,i,o,n,l){function f(t,r){for(var f=Math.max(o,t),c=Math.min(n,r),a=f;c>a;++a){var s=e.addLineClass(a,"background",l.chunk);a==t&&e.addLineClass(s,"background",l.start),a==r-1&&e.addLineClass(s,"background",l.end),i.push(s)}t==r&&f==r&&c==r&&i.push(f?e.addLineClass(f-1,"background",l.end):e.addLineClass(f,"background",l.start))}for(var c=L(0,0),a=L(o,0),s=e.clipPos(L(n-1)),d=r==DIFF_DELETE?l.del:l.insert,u=0,h=0;h<t.length;++h){var g=t[h],p=g[0],m=g[1];if(p==DIFF_EQUAL){var v=c.line+(k(t,h)?0:1);F(c,m);var D=c.line+(C(t,h)?1:0);D>v&&(h&&f(u,v),u=D)}else if(p==r){var w=F(c,m,!0),M=I(a,c),b=S(s,w);y(M,b)||i.push(e.markText(M,b,{className:d})),c=w}}u<=c.line&&f(u,c.line+1)}function d(e){if(e.showDifferences){if(e.svg){M(e.svg);var t=e.gap.offsetWidth;b(e.svg,"width",t,"height",e.gap.offsetHeight)}M(e.copyButtons);var r="left"==e.type,i=e.edit.getViewport(),o=e.orig.getViewport(),n=e.edit.getScrollInfo().top,l=e.orig.getScrollInfo().top;m(e.diff,function(f,c,a,s){if(!(a>i.to||s<i.from||f>o.to||c<o.from)){var d=e.orig.heightAtLine(f,"local")-l,u=d;if(e.svg){var h=e.edit.heightAtLine(a,"local")-n;if(r){var g=d;d=h,h=g}var p=e.orig.heightAtLine(c,"local")-l,m=e.edit.heightAtLine(s,"local")-n;if(r){var g=p;p=m,m=g}var v=" C "+t/2+" "+h+" "+t/2+" "+d+" "+(t+2)+" "+d,C=" C "+t/2+" "+p+" "+t/2+" "+m+" -1 "+m;b(e.svg.appendChild(document.createElementNS(O,"path")),"d","M -1 "+h+v+" L "+(t+2)+" "+p+C+" z","class",e.classes.connect)}var k=e.copyButtons.appendChild(w("div","left"==e.type?"\u21dd":"\u21dc","CodeMirror-merge-copy"));k.title="Revert chunk",k.chunk={topEdit:a,botEdit:s,topOrig:f,botOrig:c},k.style.top=u+"px"}})}}function u(e,t){e.diffOutOfDate||e.edit.replaceRange(e.orig.getRange(L(t.topOrig,0),L(t.botOrig,0)),L(t.topEdit,0),L(t.botEdit,0))}function h(t){var r=t.lockButton=w("div",null,"CodeMirror-merge-scrolllock");r.title="Toggle locked scrolling";var i=w("div",[r],"CodeMirror-merge-scrolllock-wrap");e.on(r,"click",function(){f(t,!t.lockScroll)}),t.copyButtons=w("div",null,"CodeMirror-merge-copybuttons-"+t.type),e.on(t.copyButtons,"click",function(e){var r=e.target||e.srcElement;r.chunk&&u(t,r.chunk)});var o=[t.copyButtons,i],n=document.createElementNS&&document.createElementNS(O,"svg");return n&&!n.createSVGRect&&(n=null),t.svg=n,n&&o.push(n),t.gap=w("div",o,"CodeMirror-merge-gap")}function g(e){return"string"==typeof e?e:e.getValue()}function p(e,t){var r=A.diff_main(e,t);A.diff_cleanupSemantic(r);for(var i=0;i<r.length;++i){var o=r[i];o[1]?i&&r[i-1][0]==o[0]&&(r.splice(i--,1),r[i][1]+=o[1]):r.splice(i--,1)}return r}function m(e,t){for(var r=0,i=0,o=L(0,0),n=L(0,0),l=0;l<e.length;++l){var f=e[l],c=f[0];if(c==DIFF_EQUAL){var a=k(e,l)?0:1,s=o.line+a,d=n.line+a;F(o,f[1],null,n);var u=C(e,l)?1:0,h=o.line+u,g=n.line+u;h>s&&(l&&t(i,d,r,s),r=h,i=g)}else F(c==DIFF_INSERT?o:n,f[1])}(r<=o.line||i<=n.line)&&t(i,n.line+1,r,o.line+1)}function v(e){r(e);var t=[];return m(e.diff,function(e,r,i,o){t.push({origFrom:e,origTo:r,editFrom:i,editTo:o})}),t}function C(e,t){if(t==e.length-1)return!0;var r=e[t+1][1];return 1==r.length||10!=r.charCodeAt(0)?!1:t==e.length-2?!0:(r=e[t+2][1],r.length>1&&10==r.charCodeAt(0))}function k(e,t){if(0==t)return!0;var r=e[t-1][1];return 10!=r.charCodeAt(r.length-1)?!1:1==t?!0:(r=e[t-2][1],10==r.charCodeAt(r.length-1))}function D(e,t,r){var i,o,n,l;return m(e,function(e,f,c,a){var s=r?c:e,d=r?a:f;null==o&&(s>t?(o=c,l=e):d>t&&(o=a,l=f)),t>=d?(i=a,n=f):t>=s&&(i=c,n=e)}),{edit:{before:i,after:o},orig:{before:n,after:l}}}function w(e,t,r,i){var o=document.createElement(e);if(r&&(o.className=r),i&&(o.style.cssText=i),"string"==typeof t)o.appendChild(document.createTextNode(t));else if(t)for(var n=0;n<t.length;++n)o.appendChild(t[n]);return o}function M(e){for(var t=e.childNodes.length;t>0;--t)e.removeChild(e.firstChild)}function b(e){for(var t=1;t<arguments.length;t+=2)e.setAttribute(arguments[t],arguments[t+1])}function E(e,t){t||(t={});for(var r in e)e.hasOwnProperty(r)&&(t[r]=e[r]);return t}function F(e,t,r,i){for(var o=r?L(e.line,e.ch):e,n=0;;){var l=t.indexOf("\n",n);if(-1==l)break;++o.line,i&&++i.line,n=l+1}return o.ch=(n?0:o.ch)+(t.length-n),i&&(i.ch=(n?0:i.ch)+(t.length-n)),o}function S(e,t){return(e.line-t.line||e.ch-t.ch)<0?e:t}function I(e,t){return(e.line-t.line||e.ch-t.ch)>0?e:t}function y(e,t){return e.line==t.line&&e.ch==t.ch}var L=e.Pos,O="http://www.w3.org/2000/svg";t.prototype={constructor:t,init:function(t,r,n){this.edit=this.mv.edit,this.orig=e(t,E({value:r,readOnly:!0},E(n))),this.diff=p(g(r),g(n.value)),this.diffOutOfDate=!1,this.showDifferences=n.showDifferences!==!1,this.forceUpdate=i(this),f(this,!0,!1),o(this)},setShowDifferences:function(e){e=e!==!1,e!=this.showDifferences&&(this.showDifferences=e,this.forceUpdate("full"))}};var T=e.MergeView=function(r,i){if(!(this instanceof T))return new T(r,i);var o=i.origLeft,n=null==i.origRight?i.orig:i.origRight,l=null!=o,f=null!=n,c=1+(l?1:0)+(f?1:0),a=[],s=this.left=null,u=this.right=null;if(l){s=this.left=new t(this,"left");var g=w("div",null,"CodeMirror-merge-pane");a.push(g),a.push(h(s))}var p=w("div",null,"CodeMirror-merge-pane");if(a.push(p),f){u=this.right=new t(this,"right"),a.push(h(u));var m=w("div",null,"CodeMirror-merge-pane");a.push(m)}(f?m:p).className+=" CodeMirror-merge-pane-rightmost",a.push(w("div",null,null,"height: 0; clear: both;"));var v=this.wrap=r.appendChild(w("div",a,"CodeMirror-merge CodeMirror-merge-"+c+"pane"));this.edit=e(p,E(i)),s&&s.init(g,o,i),u&&u.init(m,n,i);var C=function(){s&&d(s),u&&d(u)};e.on(window,"resize",C);var k=setInterval(function(){for(var t=v.parentNode;t&&t!=document.body;t=t.parentNode);t||(clearInterval(k),e.off(window,"resize",C))},5e3)};T.prototype={constuctor:T,editor:function(){return this.edit},rightOriginal:function(){return this.right&&this.right.orig},leftOriginal:function(){return this.left&&this.left.orig},setShowDifferences:function(e){this.right&&this.right.setShowDifferences(e),this.left&&this.left.setShowDifferences(e)},rightChunks:function(){return this.right&&v(this.right)},leftChunks:function(){return this.left&&v(this.left)}};var A=new diff_match_patch});